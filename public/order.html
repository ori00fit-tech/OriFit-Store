<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - OriFit Store</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¦</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --secondary: #764ba2;
      --success: #4caf50;
      --danger: #f44336;
      --text: #333;
      --text-light: #666;
      --bg: #f5f5f5;
      --white: #ffffff;
      --shadow: 0 4px 20px rgba(0,0,0,0.1);
      --radius: 12px;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      min-height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      padding: 1.5rem 0;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }
    
    .header-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
      text-align: center;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px 3rem;
    }
    
    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }
    
    .form-section {
      background: var(--white);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    .section-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: var(--text);
    }
    
    .required {
      color: var(--danger);
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #e0e0e0;
      border-radius: var(--radius);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-hint {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.3rem;
    }
    
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .payment-option {
      display: flex;
      align-items: center;
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-option:hover {
      border-color: var(--primary);
      background: #f5f5f5;
    }
    
    .payment-option input[type="radio"] {
      margin-left: 1rem;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .payment-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .payment-icon {
      font-size: 1.5rem;
      margin-left: 0.5rem;
    }
    
    .order-summary {
      background: var(--white);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 2rem;
      height: fit-content;
    }
    
    .cart-items {
      margin-bottom: 1.5rem;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .cart-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .cart-item:last-child {
      border-bottom: none;
    }
    
    .item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .item-details {
      flex: 1;
    }
    
    .item-name {
      font-weight: bold;
      margin-bottom: 0.3rem;
      font-size: 0.95rem;
    }
    
    .item-price {
      color: var(--text-light);
      font-size: 0.9rem;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.8rem;
      color: var(--text-light);
    }
    
    .summary-row strong {
      color: var(--text);
    }
    
    .summary-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 1rem 0;
    }
    
    .summary-total {
      display: flex;
      justify-content: space-between;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 1.5rem;
    }
    
    .submit-btn {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.3s;
    }
    
    .submit-btn:hover:not(:disabled) {
      transform: scale(1.02);
    }
    
    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .success-message {
      background: var(--white);
      padding: 3rem 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
    }
    
    .success-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
    }
    
    .success-message h2 {
      color: var(--success);
      margin-bottom: 1rem;
    }
    
    .order-id {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: var(--radius);
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
      margin: 1.5rem 0;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    
    @media (max-width: 768px) {
      .checkout-grid {
        grid-template-columns: 1fr;
      }
      
      .order-summary {
        position: static;
        order: -1;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>ğŸ“¦ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h1>
    </div>
  </header>

  <div class="container">
    <div id="checkoutContainer"></div>
  </div>

  <script src="translations.js"></script>
  <script>
    const API_URL = OriFitConfig.WORKER_URL;
    let cart = JSON.parse(localStorage.getItem('orifit_cart') || '[]');
    let orderData = {};

    function renderCheckout() {
      if (cart.length === 0) {
        document.getElementById('checkoutContainer').innerHTML = `
          <div class="success-message">
            <div class="success-icon">ğŸ›’</div>
            <h2>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</h2>
            <p style="color: var(--text-light); margin: 1rem 0;">
              Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†!
            </p>
            <a href="index.html" class="btn btn-primary">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
          </div>
        `;
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const defaultShipping = OriFitConfig.SHIPPING.defaultCost;
      
      document.getElementById('checkoutContainer').innerHTML = `
        <div class="checkout-grid">
          <div>
            <div class="form-section">
              <h2 class="section-title">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
              <form id="orderForm">
                <div class="form-group">
                  <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span class="required">*</span></label>
                  <input type="text" class="form-input" id="customerName" required 
                         placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø³Ù†ÙŠ">
                </div>

                <div class="form-group">
                  <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span class="required">*</span></label>
                  <input type="tel" class="form-input" id="customerPhone" required 
                         placeholder="Ù…Ø«Ø§Ù„: 0612345678 Ø£Ùˆ +212612345678">
                  <div class="form-hint">Ø³Ù†ØªØµÙ„ Ø¨Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</div>
                </div>

                <div class="form-group">
                  <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                  <input type="email" class="form-input" id="customerEmail" 
                         placeholder="Ù…Ø«Ø§Ù„: ahmed@example.com">
                  <div class="form-hint">Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</div>
                </div>

                <div class="form-group">
                  <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© <span class="required">*</span></label>
                  <select class="form-select" id="customerCity" required onchange="updateShipping()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                    ${OriFitConfig.CITIES.map(city => `<option value="${city}">${city}</option>`).join('')}
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ <span class="required">*</span></label>
                  <textarea class="form-textarea" id="customerAddress" required 
                            placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ø±Ø¹ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø®Ø§Ù…Ø³ØŒ Ø±Ù‚Ù… 123ØŒ Ø§Ù„Ø´Ù‚Ø© 5"></textarea>
                  <div class="form-hint">ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
                </div>

                <div class="form-group">
                  <label class="form-label">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ</label>
                  <input type="text" class="form-input" id="customerPostalCode" 
                         placeholder="Ù…Ø«Ø§Ù„: 10000">
                </div>

                <div class="form-group">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                  <textarea class="form-textarea" id="orderNotes" 
                            placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                </div>
              </form>
            </div>

            <div class="form-section" style="margin-top: 2rem;">
              <h2 class="section-title">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h2>
              <div class="payment-methods">
                ${OriFitConfig.PAYMENT_METHODS.map(method => `
                  <label class="payment-option ${method.disabled ? 'disabled' : ''}" 
                         style="opacity: ${method.disabled ? '0.5' : '1'}">
                    <input type="radio" name="payment" value="${method.value}" 
                           ${method.value === 'cod' ? 'checked' : ''} 
                           ${method.disabled ? 'disabled' : ''}>
                    <span class="payment-icon">${method.icon}</span>
                    <div>
                      <strong>${method.label}</strong>
                      ${method.disabled ? '<div style="font-size: 0.85rem; color: var(--text-light);">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>' : ''}
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="order-summary">
            <h3 class="section-title">ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
            
            <div class="cart-items">
              ${cart.map(item => `
                <div class="cart-item">
                  <img src="${getImageUrl(item.image_key)}" alt="${item.name}" class="item-image">
                  <div class="item-details">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">
                      ${formatPrice(item.price)} Ã— ${item.quantity} = ${formatPrice(item.price * item.quantity)}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="summary-divider"></div>

            <div class="summary-row">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
              <strong id="subtotalDisplay">${formatPrice(subtotal)}</strong>
            </div>

            <div class="summary-row">
              <span>Ø§Ù„Ø´Ø­Ù†:</span>
              <strong id="shippingDisplay">${formatPrice(defaultShipping)}</strong>
            </div>

            <div class="summary-row" id="freeShippingNotice" style="display: none; color: var(--success); font-weight: bold;">
              <span>ğŸ‰ Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ!</span>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-total">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
              <span id="totalDisplay">${formatPrice(subtotal + defaultShipping)}</span>
            </div>

            <button class="submit-btn" onclick="submitOrder()">
              âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
            </button>

            <div style="text-align: center; margin-top: 1rem;">
              <a href="cart.html" style="color: var(--primary); text-decoration: none;">
                â† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©
              </a>
            </div>
          </div>
        </div>
      `;
    }

    function updateShipping() {
      const city = document.getElementById('customerCity').value;
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      const shippingCost = calculateShipping(subtotal, city);
      const total = subtotal + shippingCost;
      
      document.getElementById('shippingDisplay').textContent = 
        shippingCost === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : formatPrice(shippingCost);
      document.getElementById('totalDisplay').textContent = formatPrice(total);
      
      const notice = document.getElementById('freeShippingNotice');
      if (shippingCost === 0 && subtotal >= OriFitConfig.SHIPPING.freeThreshold) {
        notice.style.display = 'flex';
      } else {
        notice.style.display = 'none';
      }
    }

    async function submitOrder() {
      const form = document.getElementById('orderForm');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const customerName = document.getElementById('customerName').value.trim();
      const customerPhone = document.getElementById('customerPhone').value.trim();
      const customerEmail = document.getElementById('customerEmail').value.trim();
      const customerCity = document.getElementById('customerCity').value;
      const customerAddress = document.getElementById('customerAddress').value.trim();
      const customerPostalCode = document.getElementById('customerPostalCode').value.trim();
      const orderNotes = document.getElementById('orderNotes').value.trim();
      const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

      // Validate phone
      if (!validatePhone(customerPhone)) {
        showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ - Ø§Ø³ØªØ®Ø¯Ù… ØµÙŠØºØ© Ù…ØºØ±Ø¨ÙŠØ© ØµØ­ÙŠØ­Ø©', 'error');
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const shippingCost = calculateShipping(subtotal, customerCity);

      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...';

      try {
        const response = await fetch(`${API_URL}/api/order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            customer: {
              name: customerName,
              phone: customerPhone,
              email: customerEmail || null,
              city: customerCity,
              address: customerAddress,
              postal_code: customerPostalCode || null,
              payment_method: paymentMethod === 'cod' ? 'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : paymentMethod
            },
            items: cart,
            shipping_cost: shippingCost,
            notes: orderNotes || null
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨');
        }

        // Clear cart
        localStorage.removeItem('orifit_cart');
        
        // Show success message
        showSuccessMessage(data.data);

      } catch (error) {
        console.error('Order submission error:', error);
        showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
      }
    }

    function showSuccessMessage(orderData) {
      document.getElementById('checkoutContainer').innerHTML = `
        <div class="success-message">
          <div class="success-icon">âœ…</div>
          <h2>ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
          <p style="color: var(--text-light); margin: 1rem 0;">
            Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
          </p>
          
          <div class="order-id">
            Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${orderData.order_id}
          </div>

          <div style="background: #f5f5f5; padding: 1.5rem; border-radius: var(--radius); margin: 1.5rem 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
              <strong>${formatPrice(orderData.subtotal)}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>Ø§Ù„Ø´Ø­Ù†:</span>
              <strong>${orderData.shipping_cost === 0 ? 'Ù…Ø¬Ø§Ù†ÙŠ' : formatPrice(orderData.shipping_cost)}</strong>
            </div>
            ${orderData.discount > 0 ? `
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--success);">
                <span>Ø§Ù„Ø®ØµÙ…:</span>
                <strong>-${formatPrice(orderData.discount)}</strong>
              </div>
            ` : ''}
            <div style="height: 1px; background: #ddd; margin: 0.5rem 0;"></div>
            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; color: var(--primary);">
              <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
              <span>${formatPrice(orderData.total)}</span>
            </div>
          </div>

          <div style="background: #e3f2fd; padding: 1rem; border-radius: var(--radius); margin: 1.5rem 0; text-align: right;">
            <strong>ğŸ“ Ø³Ù†ØªØµÙ„ Ø¨Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</strong><br>
            <span style="font-size: 0.9rem; color: var(--text-light);">
              ${orderData.estimated_delivery || 'Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 2-5 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„'}
            </span>
          </div>

          <div class="action-buttons">
            <a href="index.html" class="btn btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
            <button onclick="window.print()" class="btn btn-secondary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          </div>
        </div>
      `;
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      renderCheckout();
    });
  </script>
</body>
</html>
